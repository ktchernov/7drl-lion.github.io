(function(){$.fn.times=function(a){var b,c,d,e,f;d=$(this)[0],f=[];for(b=c=0,e=d;0<=e?c<e:c>e;b=0<=e?++c:--c)f.push(a(b));return f},$.fn.random_element=function(a){var b,c;return b=$(this),c=ROT.RNG.getUniformInt(0,b.length-1),this[c]},$.fn.all=function(a){var b;return b=!0,this.each(function(){if(!a(this,this))return b=!1,!1}),b},$.fn.any=function(a){var b;return b=!1,this.each(function(){if(!!a(this,this))return b=!0,!1}),b}}).call(this),function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}};b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function b(){this.key_down=c(this.key_down,this),this.elem=window,this.target=null,$(this.elem).keydown(this.key_down)}var a;return a={27:"esc",37:"left",38:"up",39:"right",40:"down",32:"space",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",96:"num0",97:"num1",98:"num2",99:"num3",100:"num4",101:"num5",102:"num6",103:"num7",104:"num8",105:"num9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},b.prototype.set_target=function(a){return this.target=a},b.prototype.clear_target=function(){return this.target=null},b.prototype.key_down=function(b){var c,d;if(!this.target)return;d=a[b.which];if(!d)return;return c={shift:b.shiftKey,ctrl:b.ctrlKey},this.target.on_key(d,c)},b}(),b.Keyboard=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a.clampedNormal=function(a,b){var c;return c=ROT.RNG.getNormal(a,b),c=Math.round(c),c=Math.min(c,Math.round(a+4*b)),c=Math.max(c,Math.round(a-4*b)),c=Math.max(c,0),c},a}(),b.RNG=a}.call(this),function(){var a,b,c,d,e,f,g;g=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.actor=a,this.state=b}return a}(),b=[],c={},f=function(a){var d;return d=new a,b.push(d),c[d.key]=d},e=function(){return b},d=function(a){return c[a]},g.Alignment=a,g.register_alignment=f,g.list_alignments=e,g.get_alignment=d}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="evil",c}(Alignment),register_alignment(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="good",c}(Alignment),register_alignment(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="neutral",c}(Alignment),register_alignment(a)}.call(this),function(){var a,b,c,d,e,f,g;g=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),b=[],c={},f=function(a){var c;return c=new a,b.push(c),b[c.key]=c},e=function(){return b},d=function(a){return c[a]},g.Gender=a,g.register_gender=f,g.list_genders=e,g.get_gender=d}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="male",c.prototype.name="male",c.prototype.base_hp=4,c.prototype.base_mp=0,c.prototype.base_speed=0,c.prototype.base_attack=3,c.prototype.base_sight_range=0,c}(Gender),register_gender(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="female",c.prototype.name="female",c.prototype.base_hp=0,c.prototype.base_mp=5,c.prototype.base_speed=-10,c.prototype.base_attack=0,c.prototype.base_sight_range=2,c}(Gender),register_gender(a)}.call(this),function(){var a,b,c,d,e,f,g,h;h=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),e=[],f={},g=function(a){var b;return b=new a,e.push(b),f[b.key]=b},c=function(a){return a.player?_.filter(e,function(a){return a.for_player}):a.rarity?_.filter(e,function(b){return _.contains(b.rarity,a.rarity)}):e},d=function(a){return _.filter(e,function(b){return _.contains(b.alignments,a)})},b=function(a){return f[a]},h.Race=a,h.register_race=g,h.list_races=c,h.list_races_for_alignment=d,h.get_race=b}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="catfolk",c.prototype.name="catfolk",c.prototype.alignments=["good"],c.prototype.rarity=["uncommon","trash"],c.prototype.base_hp=10,c.prototype.base_mp=30,c.prototype.base_speed=120,c.prototype.base_attack=8,c.prototype.base_sight_range=14,c.prototype.for_player=!1,c.prototype.can_get_through_rubble=!0,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="demon",c.prototype.name="demon",c.prototype.alignments=["evil"],c.prototype.rarity=["uncommon","rare"],c.prototype.base_hp=20,c.prototype.base_mp=15,c.prototype.base_speed=100,c.prototype.base_attack=10,c.prototype.base_sight_range=9,c.prototype.for_player=!1,c.prototype.can_get_through_rubble=!0,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="dragon",c.prototype.name="dragon",c.prototype.alignments=["good","neutral","evil"],c.prototype.rarity=["uncommon","rare"],c.prototype.base_hp=30,c.prototype.base_mp=20,c.prototype.base_speed=130,c.prototype.base_attack=15,c.prototype.base_sight_range=10,c.prototype.for_player=!1,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="dwarf",c.prototype.name="dwarf",c.prototype.alignments=["good"],c.prototype.rarity=["uncommon","trash"],c.prototype.base_hp=15,c.prototype.base_mp=30,c.prototype.base_speed=80,c.prototype.base_attack=12,c.prototype.base_sight_range=8,c.prototype.for_player=!0,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="elf",c.prototype.name="elf",c.prototype.alignments=["good"],c.prototype.rarity=["uncommon","trash"],c.prototype.base_hp=15,c.prototype.base_mp=30,c.prototype.base_speed=100,c.prototype.base_attack=10,c.prototype.base_sight_range=10,c.prototype.for_player=!0,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="giant",c.prototype.name="giant",c.prototype.alignments=["good","neutral"],c.prototype.rarity=["uncommon","rare"],c.prototype.base_hp=30,c.prototype.base_mp=5,c.prototype.base_speed=70,c.prototype.base_attack=20,c.prototype.base_sight_range=6,c.prototype.for_player=!0,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="gnome",c.prototype.name="gnome",c.prototype.alignments=["good"],c.prototype.rarity=["trash"],c.prototype.base_hp=10,c.prototype.base_mp=30,c.prototype.base_speed=80,c.prototype.base_attack=10,c.prototype.base_sight_range=8,c.prototype.for_player=!1,c.prototype.can_get_through_rubble=!0,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="hobbit",c.prototype.name="hobbit",c.prototype.alignments=["good"],c.prototype.rarity=["trash"],c.prototype.base_hp=10,c.prototype.base_mp=20,c.prototype.base_speed=90,c.prototype.base_attack=10,c.prototype.base_sight_range=8,c.prototype.for_player=!1,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="human",c.prototype.name="human",c.prototype.alignments=["good","neutral","evil"],c.prototype.rarity=["trash","uncommon"],c.prototype.base_hp=20,c.prototype.base_mp=20,c.prototype.base_speed=100,c.prototype.base_attack=10,c.prototype.base_sight_range=8,c.prototype.for_player=!0,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="vampire",c.prototype.name="vampire",c.prototype.alignments=["evil"],c.prototype.rarity=["uncommon","rare"],c.prototype.base_hp=15,c.prototype.base_mp=15,c.prototype.base_speed=120,c.prototype.base_attack=15,c.prototype.base_sight_range=10,c.prototype.for_player=!1,c.prototype.can_get_through_rubble=!0,c.prototype.skills=[],c}(Race),register_race(a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.key="werewolf",c.prototype.name="werewolf",c.prototype.alignments=["neutral","evil"],c.prototype.rarity=["uncommon","rare"],c.prototype.base_hp=20,c.prototype.base_mp=20,c.prototype.base_speed=100,c.prototype.base_attack=10,c.prototype.base_sight_range=10,c.prototype.for_player=!1,c.prototype.skills=["berserk"],c}(Race),register_race(a)}.call(this),function(){var a,b,c,d,e,f,g,h,i;i=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),b=[],c={},h=function(a){var d;return d=new a,b.push(d),c[d.key]=d},e=function(){return b},g=function(a){return _.filter(b,function(b){return _.contains(b.races,a)})},f=function(a,c){return _.filter(b,function(b){return _.contains(b.alignments,a)&&_.contains(b.races,c)})},d=function(a){return c[a]},i.Class=a,i.register_class=h,i.list_classes=e,i.list_classes_for_race=g,i.list_classes_for_alignment_and_race=f,i.get_class=d}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="monk",a.prototype.name="monk",a.prototype.genders=["male","female"],a.prototype.alignments=["good","neutral"],a.prototype.races=["dwarf","elf","human","werewolf","dragon","giant","angel","catfolk","gnome","hobbit"],a.prototype.base_hp=-5,a.prototype.base_mp=10,a.prototype.base_speed=50,a.prototype.base_attack=0,a.prototype.base_sight_range=0,a.prototype.skills=[],a}(),register_class(a)}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="paladin",a.prototype.name="paladin",a.prototype.genders=["male","female"],a.prototype.alignments=["good"],a.prototype.races=["human","giant","angel","elf","dwarf","hobbit"],a.prototype.base_hp=10,a.prototype.base_mp=10,a.prototype.base_speed=-30,a.prototype.base_attack=4,a.prototype.base_sight_range=0,a.prototype.skills=["healing_aura","smite","shield_bash","divine_shield","retribution","blessing","sanctuary","beacon_of_light","blinding_light","healing_touch"],a}(),register_class(a)}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="rogue",a.prototype.name="rogue",a.prototype.genders=["male","female"],a.prototype.alignments=["neutral","evil"],a.prototype.races=["human","werewolf","demon","catfolk","gnome","vampire","dwarf","hobbit"],a.prototype.base_hp=-5,a.prototype.base_mp=-10,a.prototype.base_speed=75,a.prototype.base_attack=0,a.prototype.base_sight_range=0,a.prototype.skills=["stealth","double_strike","apply_poison","counterattack","evade","distract","fan_of_knives","shadowstep","steal","preparation"],a}(),register_class(a)}.call(this),function(){var a;a=function(){function a(){}return a.prototype.key="warrior",a.prototype.name="warrior",a.prototype.genders=["male","female"],a.prototype.alignments=["good","neutral","evil"],a.prototype.races=["human","werewolf","dragon","giant","angel","demon","catfolk","elf","dwarf","hobbit","vampire"],a.prototype.base_hp=10,a.prototype.base_mp=-10,a.prototype.base_speed=0,a.prototype.base_attack=5,a.prototype.base_sight_range=0,a.prototype.skills=["whirlwind_strike","cleave","berserk","charge","bash","heavy_strike","skull_crack","savage_leap","adrenaline","cripple"],a}(),register_class(a)}.call(this),function(){var a,b,c,d,e,f,g,h=[].slice;g=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b,c){this.duration=a,this.entity=b,this.state=c,this.entity&&(this.id=this.entity.id)}return a.prototype.active=function(){return this.duration>0},a.prototype.start=function(){return this.on_start()},a.prototype.end=function(){return this.on_end()},a.prototype.run=function(){this.duration-=1,this.state.exists(this.id)?this.on_run():this.duration=0;if(this.duration<=0)return this.on_end()},a.prototype.on_start=function(){},a.prototype.on_end=function(){},a.prototype.on_run=function(){},a.prototype.execute_action=function(){var a,b,c,d;return d=arguments[0],c=2<=arguments.length?h.call(arguments,1):[],a=get_action(d),b=new a(this.entity,this.state),b.run.apply(b,c)},a}(),b=[],c={},f=function(a,d){var e;return e=d,b.push(e),c[a]=e},e=function(){return b},d=function(a){return c[a]},g.Geas=a,g.register_geas=f,g.list_geass=e,g.get_geas=d}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.on_start=function(){this.state.msg(this.id,"You descend into a berserk rage.");if(this.id===this.state.player_id)return SoundEffects.get().play_berserk()},c.prototype.on_run=function(){var a,b,c,d,e,f,g;a=this.state.get_adjacent_positions(this.id),d=[],_.each(a,function(a){return function(b){var c;if((c=a.state).is_creature.apply(c,b))return d.push(b)}}(this));if(d.length>0)return g=$(d).random_element(),e=g[0],f=g[1],c=this.state.general_direction(this.id,e,f),this.execute_action("attack",c,{mod:2,flavor:"obliterate"});b=this.state.get_closest_creature(this.id,{range:6});if(b)return c=this.state.general_direction(this.id,this.state.get_pos(b)),this.execute_action("move",c)},c.prototype.on_end=function(){return this.state.msg(this.id,"The berserk rage lapses.")},c}(Geas),register_geas("berserk",a)}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=[].slice;m=typeof exports!="undefined"&&exports!==null?exports:this,f=0,c=1,b=2,d=3,g=4,e=5,a=function(){function a(a,b){this.entity=a,this.state=b,this.entity&&(this.id=this.entity.id)}return a.prototype.target=f,a.prototype.add_geas=function(a,b,c){var d,e,f,g;return this.entity=a,g=this.entity.id,d=get_geas(c),f=new d(b,this.entity,this.state),e=this.state.get_actor(g),e.add_geas(f)},a.prototype.execute_action=function(){var b,c,d;return d=arguments[0],c=2<=arguments.length?n.call(arguments,1):[],a=j(d),b=new a(this.entity,this.state),b.run.apply(b,c)},a}(),h=[],i={},l=function(a,b){var c;return c=b,h.push(c),i[a]=c},k=function(){return h},j=function(a){return i[a]},m.Action=a,m.register_action=l,m.list_actions=k,m.get_action=j,m.TARGET_NONE=f,m.TARGET_DIR8=c,m.TARGET_DIR4=b,m.TARGET_FOV=d,m.TARGET_RANGE=g,m.TARGET_MENU=e}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.run=function(a,b){var c,d,e,f,g,h,i;b==null&&(b={}),b.mod==null&&(b.mod=1),b.flavor==null&&(b.flavor="attack"),g=this.state.get_adjacent_pos(this.id,a),e=g[0],f=g[1],d=this.state.get_attack(this.id),d=Math.round(d*b.mod),h=this.state.get_by_pos(e,f);if(h)return c=this.state.get_short_description(this.id),i=this.state.get_short_description(h),this.state.msg(this.id,"You "+b.flavor+" "+i+"."),_.str.endsWith(b.flavor,"sh")&&(b.flavor=b.flavor+"e"),this.state.msg(h,_.str.capitalize(c)+" "+b.flavor+"s you!"),this.state.damage(h,d),SoundEffects.get().play_hit(),this.state.is_dead(h)&&(this.state.msg(this.id,"You killed "+i+"!"),this.state.msg(h,"You are dead!"),this.state.remove(h)),!0},c}(Action),register_action("attack",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function g(){return g.__super__.constructor.apply(this,arguments)}var c,d,e,f;return b(g,a),g.prototype.target=TARGET_DIR8,f=90,c=50,e=12,d=18,g.prototype.run=function(a){var b,c,d;return d=this.state.get_adjacent_pos(this.id,a),b=d[0],c=d[1],this.state.is_wall(b,c)?this.state.is_rubble(b,c)?this._dig_rubble(b,c):this._dig_hard_rock(b,c):this.state.msg(this.id,"You dig at the thin air, that'll show 'em!"),!0},g.prototype._dig_rubble=function(a,b){return this._alert_enemies(a,b,e),ROT.RNG.getPercentage()<=f?(this.state.msg(this.id,"You have dug throug the rubble!"),this.state.remove_rubble(a,b),SoundEffects.get().play_dig_rubble()):(this.state.msg(this.id,"You chip away at the rubble. Need to put more muscle into it."),SoundEffects.get().play_dig())},g.prototype._dig_hard_rock=function(a,b){return this._alert_enemies(a,b,d),ROT.RNG.getPercentage()<=c?(this.state.msg(this.id,"You chip away at the hard rock wall, cracks are beginning to show!"),this.state.make_rubble(a,b),SoundEffects.get().play_dig_rubble()):(this.state.msg(this.id,"You slowly chip away at the hard rock wall, you may need to do this for a while..."),SoundEffects.get().play_dig())},g.prototype._alert_enemies=function(a,b,c){var d,e,f,g,h,i;h=this.state.get_nearby_creatures(this.id,{range:c}),d=!1,i=[];for(f=0,g=h.length;f<g;f++)e=h[f],e.alert_by_sound()&&!d?i.push(this.state.msg(this.id,"So much noise! You have alerted nearby enemies!")):i.push(void 0);return i},g}(Action),register_action("dig",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.run=function(a){var b,c,d;return d=this.state.get_adjacent_pos(this.id,a),b=d[0],c=d[1],this._can_move_to(b,c)?(this._move_to(b,c),!0):this.state.is_rubble(b,c)?(this.state.msg(this.id,"Pile of rocks blocks your way, digging might help."),!1):(this.state.msg(this.id,"You can't go that way."),!1)},c.prototype._can_move_to=function(a,b){return this.entity.get_through_rubble?!this.state.is_creature(a,b)&&(this.state.is_rubble(a,b)||!this.state.is_wall(a,b)):!this.state.is_blocked(a,b)},c.prototype._move_to=function(a,b){var c;this.state.set_pos(this.id,a,b),this.entity.can_pick_up_gold&&this.state.has_gold(a,b)&&this.state.pickup_gold(a,b,this.id),this.entity.can_pick_up_potions&&this.state.get_potion(a,b)&&this.state.pickup_potion(a,b,this.id),this.state.set_off_triggers(this.id);if(this.id!==this.state.player_id&&this.state.is_rubble(a,b)&&this.state.is_visible_to_player(a,b))return c=this.state.get_short_description(this.id),this.state.msg(this.state.player_id,_.str.capitalize(c)+" glides through the rubble!")},c}(Action),register_action("move",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.run=function(a,b){var c,d,e;return b==null&&(b={}),e=this.state.get_adjacent_pos(this.id,a),c=e[0],d=e[1],this.state.is_creature(c,d)?this.execute_action("attack",a,b):this.execute_action("move",a)},c}(Action),register_action("move_or_attack",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_NONE,c.prototype.run=function(){return!0},c}(Action),register_action("wait",a)}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=function(a,b){function d(){this.constructor=a}for(var c in b)p.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},p={}.hasOwnProperty;l=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return o(b,a),b}(Action),m=[],n={},k=function(a,b){var c;return c=b,m.push(c),n[a]=c},g=function(){return m},f=function(){var a;return a=[],_.each(m,function(b){var c;return c=new b,a.push(c.key)}),a},c=function(a){return n[a]},h=[],i={},j=function(a,b){var c;return c=b,h.push(c),i[a]=c},e=function(){return h},d=function(){var a;return a=[],_.each(h,function(b){var c;return c=new b,a.push(c.key)}),a},b=function(a){return i[a]},l.Skill=a,l.register_skill=k,l.list_skills=g,l.list_skill_keys=f,l.get_skill=c,l.register_monster_skill=j,l.list_monster_skills=e,l.list_monster_skill_keys=d,l.get_monster_skill=b}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_NONE,c.prototype.key="adrenaline",c.prototype.name="adrenaline",c.prototype.mp=8,c.prototype.cooldown=15,c.prototype.run=function(a){return!0},c}(Skill)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.key="bash",c.prototype.name="bash",c.prototype.mp=3,c.prototype.cooldown=2,c.prototype.run=function(a){var b,c,d,e,f,g,h,i;f=this.state.get_adjacent_pos(this.id,a),b=f[0],c=f[1],i=this.state.get_by_pos(b,c);if(!i)return;return g=this.state.get_adjacent(b,c,a),d=g[0],e=g[1],this.state.is_blocked(d,e)?(this.execute_action("attack",a,{mod:1.4,flavor:"bash"}),h=this.state.get_by_pos(d,e),h&&(this.state.damage(h,this.state.get_attack(this.id)*.2),this.state.msg(h,"Something bashes into you."))):(this.execute_action("attack",a,{mod:.8,flavor:"push"}),this.state.exists(i)&&this.state.set_pos(i,d,e),this.state.set_pos(this.id,b,c)),this.id===this.state.player_id&&SoundEffects.get().play_skill_used(),!0},c}(Skill),register_skill("bash",a),register_monster_skill("bash",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_NONE,c.prototype.key="berserk",c.prototype.name="berserk",c.prototype.mp=15,c.prototype.cooldown=10,c.prototype.run=function(a){return this.add_geas(this.entity,5,"berserk")},c}(Skill),register_skill("berserk",a),register_monster_skill("berserk",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.key="charge",c.prototype.name="charge",c.prototype.mp=8,c.prototype.cooldown=5,c.prototype.run=function(a){var b,c,d,e,f,g,h;return e=this.state.get_pos(this.id),c=e[0],d=e[1],f=this.state.find_in_direction(c,d,a,function(b){return function(c,d,e){return b.state.is_blocked_in_dir(c,d,a)||e>=6}}(this)),g=f[0],h=f[1],g===c&&h===d?!1:(b=this.state.get_short_description(this.id),this.state.msg(this.id,"You shout wildly and charge!"),this.state.shout_by(this.id,_.str.capitalize(b)+" shouts wildly and charges!"),this.state.set_pos(this.id,g,h),this.execute_action("attack",a),this.id===this.state.player_id&&SoundEffects.get().play_skill_used(),!0)},c}(Skill),register_skill("charge",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.key="cleave",c.prototype.name="cleave",c.prototype.mp=4,c.prototype.cooldown=4,c.prototype.run=function(a){var b,c,d,e;return c=[a,this.state.rotate_right(a),this.state.rotate_left(a)],d=[],$.each(c,function(a){return function(b,c){return d.push(a.state.get_adjacent_pos(a.id,c))}}(this)),b=this.state.get_attack(this.id),b=Math.ceil(b*.5),e=!1,$.each(d,function(a){return function(c,d){var f,g,h,i,j;i=d[0],j=d[1],g=a.state.get_by_pos(i,j);if(g)return f=a.state.get_short_description(a.id),h=a.state.get_short_description(g),a.state.msg(a.id,"You cleave "+h+"."),a.state.msg(g,_.str.capitalize(f)+"'s cleaves you!"),a.state.damage(g,b),a.state.is_dead(g)&&(a.state.msg(a.id,"You killed "+h+"!"),a.state.msg(g,"You are dead!"),a.state.remove(g)),e=!0}}(this)),e&&this.id===this.state.player_id&&SoundEffects.get().play_skill_used(),e},c}(Skill),register_skill("cleave",a),register_monster_skill("cleave",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.key="cripple",c.prototype.name="cripple",c.prototype.mp=0,c.prototype.cooldown=10,c.prototype.run=function(a){return!0},c}(Skill)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.key="heavy_strike",c.prototype.name="heavy strike",c.prototype.mp=5,c.prototype.cooldown=5,c.prototype.run=function(a){this.execute_action("attack",a,{mod:1.5,flavor:"demolish"});if(this.id===this.state.player_id)return SoundEffects.get().play_skill_used()},c}(Skill),register_skill("heavy_strike",a),register_monster_skill("heavy_strike",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty,d=[].slice;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.key="savage_leap",c.prototype.name="savage leap",c.prototype.mp=5,c.prototype.cooldown=10,c.prototype.run=function(a){var b,c,e,f,g,h,i,j,k;h=this.state.get_pos(this.id),f=h[0],g=h[1],i=this.state.pos_in_direction(f,g,a,3),j=i[0],k=i[1];if(this.state.is_blocked(j,k))return;c=this.state.get_all_adjacent_pos(j,k),e=[],_.each(c,function(a){return function(b){var c;if((c=a.state).is_creature.apply(c,b))return e.push(b)}}(this));if(e.length===0)return;return b=this.state.get_short_description(this.id),this.state.msg(this.id,"You leap into the fray!"),this.state.shout_by(this.id,_.str.capitalize(b)+" leaps into the fray!"),this.state.set_pos(this.id,j,k),_.each(e,function(b){return function(c){var e;return a=(e=b.state).general_direction.apply(e,[b.id].concat(d.call(c))),b.execute_action("attack",a,{mod:.2,flavor:"stomp"})}}(this)),!0},c}(Skill),register_skill("savage_leap",a)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_DIR8,c.prototype.key="skull_crack",c.prototype.name="skull crack",c.prototype.mp=3,c.prototype.cooldown=3,c.prototype.run=function(a){return!0},c}(Skill)}.call(this),function(){var a,b=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},c={}.hasOwnProperty;a=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.target=TARGET_NONE,c.prototype.key="whirlwind_strike",c.prototype.name="whirlwind strike",c.prototype.mp=10,c.prototype.cooldown=5,c.prototype.run=function(){var a,b;return b=this.state.get_adjacent_positions(this.id),a=this.state.get_attack(this.id),a=Math.ceil(a*.25),$.each(b,function(b){return function(c,d){var e,f,g,h,i;h=d[0],i=d[1],f=b.state.get_by_pos(h,i);if(f)return e=b.state.get_short_description(b.id),g=b.state.get_short_description(f),b.state.msg(b.id,"You hit "+g+"."),b.state.msg(f,_.str.capitalize(e)+"'s whirlwind strike hits you!"),b.state.damage(f,a),b.state.is_dead(f)&&(b.state.msg(b.id,"You killed "+g+"!"),b.state.msg(f,"You are dead!"),b.state.remove(f)),b.id===b.state.player_id&&SoundEffects.get().play_skill_used(),!0}}(this)),!0},c}(Skill),register_skill("whirlwind_strike",a),register_monster_skill("whirlwind_strike",a)}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function c(){}var a,b;return b=null,c.get=function(){return b!=null?b:b=new a},a=function(){function a(){var a,b,c,d;d=.3,c=d+.15,b=.05,a={hit1:["noise",0,d,0,.004,0,.166,20,936,2400,-0.308,0,0,.01,3e-4,0,0,0,0,0,0,0,0,1,0,0,.039,0],hit2:["noise",0,d,0,.004,0,.27,20,467,2400,-0.53,0,0,.01,3e-4,0,0,0,0,0,0,0,0,1,0,0,0,0],hit3:["noise",0,d,0,.012,0,.14,20,948,2400,-0.578,0,0,.01,3e-4,0,0,0,0,0,0,0,0,1,0,0,.236,0],hit4:["noise",0,d,0,.03,0,.252,20,835,2400,-0.42,0,0,.01,3e-4,0,0,0,0,0,0,0,0,1,0,0,.12,0],death:["noise",0,c,0,.3,.738,1.104,20,1534,2400,-0.258,0,0,.01,3e-4,0,0,0,0,0,0,0,0,1,0,0,0,0],skill_gained:["synth",0,d,0,.4,0,.152,20,585,2400,.192,0,.327,29.6678,3e-4,0,0,0,.5,0,0,0,0,1,0,0,0,0],level_up:["synth",0,d,0,.624,0,.536,20,197,2400,.372,-0.304,.198,18.7261,3e-4,0,0,0,0,0,0,0,0,1,0,0,0,0]},this.effects=jsfxlib.createWaves(a),this.effects.berserk=this.load("media/effect_scream.mp3"),this.effects.restore1=this.load("media/effect_restore1.mp3"),this.effects.restore2=this.load("media/effect_restore2.mp3"),this.effects.clank=this.load("media/effect_clank.mp3"),this.effects.cleave=this.load("media/effect_cleave.mp3"),this.effects.use_skill=this.load("media/effect_grunt.mp3"),this.effects.descend=this.load("media/effect_jump_down.mp3"),this.effects.dig=this.load("media/effect_dig.mp3"),this.effects.dig_rubble=this.load("media/effect_dig_rubble.mp3"),this.effects.coins=this.load("media/effect_coins.mp3")}return a.prototype.load=function(a){return new Howl({urls:[a]})},a.prototype.play_berserk=function(){return this.effects.berserk.play()},a.prototype.play_skill_used=function(){return this.effects.cleave.play()},a.prototype.play_skill_gained=function(){return this.effects.skill_gained.play()},a.prototype.play_level_up=function(){return this.effects.level_up.play()},a.prototype.play_clank=function(){var a;return a=setInterval(function(b){return function(){return b.effects.clank.play(),clearInterval(a)}}(this),1e3)},a.prototype.play_descend=function(){return this.effects.descend.play()},a.prototype.play_restore_hp=function(){return this.effects.restore2.play()},a.prototype.play_restore_mp=function(){return this.effects.restore1.play()},a.prototype.play_dig_rubble=function(){return this.effects.dig_rubble.play()},a.prototype.play_dig=function(){return this.effects.dig.play()},a.prototype.play_hit=function(){var a;return a=ROT.RNG.getPercentage(),a<=25?this.effects.hit1.play():a<=50?this.effects.hit2.play():a<=75?this.effects.hit3.play():this.effects.hit4.play()},a.prototype.play_death=function(){return this.effects.death.play()},a.prototype.play_coin=function(){return this.effects.coins.play()},a}(),c}(),b.SoundEffects=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a){a==null&&(a={}),this.id=a.id,this.x=a.x,this.y=a.y,this.level=a.level,this.xp=0,this.rarity=a.rarity,this.alignment=a.alignment,this.gender=a.gender,this.race=a.race,this["class"]=a["class"],this.base_attack=a.base_attack,this.attack=this.base_attack,this.base_speed=a.base_speed,this.speed=this.base_speed,this.base_hp=a.base_hp,this.max_hp=this.base_hp,this.hp=this.max_hp,this.base_mp=a.base_mp,this.base_mp=Math.max(0,this.base_mp),this.max_mp=this.base_mp,this.mp=this.max_mp,this.short_description="a "+this.race.name+" "+this["class"].name,this.dead=a.dead,this.skills=[],this._add_skills(a.skills),this.surge_grant_chance=a.surge_grant_chance,this.kill_xp=a.kill_xp,this.sight_range=a.sight_range,this.get_through_rubble=a.get_through_rubble,this.gold=a.gold,this.gold==null&&(this.gold=0),this.can_pick_up_gold=a.can_pick_up_gold,this.can_pick_up_potions=a.can_pick_up_potions}return a.prototype.pos=function(){return[this.x,this.y]},a.prototype.set_pos=function(a,b){this.x=a,this.y=b},a.prototype.level_up=function(){var a;return this.level+=1,this.xp=0,a=this._level_up_stat("max_hp","base_hp"),this.hp+=a,a=this._level_up_stat("max_mp","base_hp"),this.mp+=a,this._level_up_stat("attack","base_attack"),this._level_up_speed()},a.prototype.add_skill=function(a){var b,c;b=get_skill(a);if(!b)throw new Error("Could not find skill with key: "+a);return c=new b(null,null),this.skills.push({key:a,name:c.name,mp:c.mp,base_cooldown:c.cooldown,cooldown_timer:0})},a.prototype._level_up_stat=function(a,b){var c;return c=Math.ceil(this[b]*.03333),this[a]+=c,c},a.prototype._level_up_speed=function(){return this.speed=Math.ceil(this.speed*.96667)},a.prototype._add_skills=function(a){return _.each(a,function(a){return function(b){return a.add_skill(b)}}(this))},a}(),b.Entity=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a.prototype.generate_id=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=Math.random()*16|0,c=a==="x"?b:b&3|8,c.toString(16)})},a}(),b.EntityGenerator=a}.call(this),function(){var a,b,c=function(a,b){function e(){this.constructor=a}for(var c in b)d.call(b,c)&&(a[c]=b[c]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},d={}.hasOwnProperty;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.generate=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;h=$(list_genders()).random_element(),n=$(list_races({rarity:a})).random_element(),m=$(list_classes_for_race(n.key)).random_element();if(!m)throw new Error("No class for "+n.key);return o=function(){switch(a){case"trash":return.15;case"uncommon":return.3;case"rare":return.6}}(),o+=o*(b-1)*.2,r=function(){switch(a){case"trash":return 0;case"uncommon":return 20;case"rare":return 100}}(),l=function(){switch(a){case"trash":return.06;case"uncommon":return.2;case"rare":return.6}}(),j=function(){switch(a){case"trash":return 0;case"uncommon":return 20;case"rare":return 100}}(),i=0,j&&(j+=j*(b-1)*.2,k=j/5,i=RNG.clampedNormal(j,k)),g=function(){switch(a){case"trash":return 0;case"uncommon":return!0;case"rare":return!0}}(),c=h.base_attack+n.base_attack+m.base_attack,c=Math.ceil(c*o),d=h.base_hp+n.base_hp+m.base_hp,d=Math.ceil(d*o),e=h.base_mp+n.base_mp+m.base_mp,e=Math.ceil(e*o),f=h.base_speed+n.base_speed+m.base_speed,f=Math.ceil(f*Math.pow(.9,b-1)),q=$(list_monster_skill_keys()).random_element(),p=h.base_sight_range+n.base_sight_range+m.base_sight_range,new Entity({id:this.generate_id(),x:0,y:0,level:1,gender:h,race:n,"class":m,base_attack:c,base_speed:f,base_hp:d,base_mp:e,dead:!1,rarity:a,skills:[q],surge_grant_chance:r,gold:i,kill_xp:l,get_through_rubble:n.can_get_through_rubble,sight_range:p,can_pick_up_gold:g})},b}(EntityGenerator),b.MonsterGenerator=a}.call(this),function(){var a,b,c=function(a,b){function e(){this.constructor=a}for(var c in b)d.call(b,c)&&(a[c]=b[c]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},d={}.hasOwnProperty;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.generate=function(a,b,c){var d;return d=$(list_skill_keys()).random_element(),new Entity({id:this.generate_id(),x:0,y:0,level:1,gender:a,race:b,"class":c,base_attack:a.base_attack+b.base_attack+c.base_attack,base_speed:a.base_speed+b.base_speed+c.base_speed,base_hp:a.base_hp+b.base_hp+c.base_hp,base_mp:a.base_mp+b.base_mp+c.base_mp,dead:!1,rarity:"player",skills:[d],sight_range:a.base_sight_range+b.base_sight_range+c.base_sight_range,can_pick_up_gold:!0,can_pick_up_potions:!0})},b}(EntityGenerator),b.PlayerGenerator=a}.call(this),function(){var a,b,c,d,e,f,g,h=[].slice;g=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b,c){this.entity=a,this.scheduler=b,this.state=c,this.id=this.entity.id,this.acting=!1,this.removed=function(){},this.geas=null}return a.prototype.on_remove=function(a){return this.removed=a},a.prototype.act=function(){if(this.acting)throw new Error("Already acting!");this.acting=!0;if(this._removed_check()){this.removed();return}if(this.geas){this.run_geas(),this.after_geas_run();return}return this.on_act()},a.prototype.done=function(a){return a==null&&(a=this.entity.speed),this.scheduler.setDuration(a),this.acting=!1},a.prototype.add_geas=function(a){return this.geas=a,this.geas.start()},a.prototype.run_geas=function(){return this.geas.run(),this.geas.active()||(this.geas=null),this.done(),this.on_geas_done()},a.prototype.on_geas_done=function(){},a.prototype.after_geas_run=function(){},a.prototype.execute_action=function(){var a,b,c,d;return d=arguments[0],c=2<=arguments.length?h.call(arguments,1):[],a=get_action(d),b=new a(this.entity,this.state),b.run.apply(b,c)},a.prototype.alert_by_sound=function(){},a.prototype._removed_check=function(){return!this.state.exists(this.id)},a}(),b=[],c={},f=function(a,d){var e;return e=d,b.push(e),c[a]=e},e=function(){return b},d=function(a){return c[a]},g.Actor=a,g.register_actor=f,g.list_actors=e,g.get_actor=d}.call(this),function(){var a,b,c=function(a,b){function e(){this.constructor=a}for(var c in b)d.call(b,c)&&(a[c]=b[c]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},d={}.hasOwnProperty,e=[].slice;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(a,c,d,e){this.engine=d,b.__super__.constructor.call(this,a,c,e),this._is_alerted=!1}return c(b,a),b.prototype.on_act=function(){var a,b,c,d,f,g,h,i,j,k,l,m,n,o,p;return this.state.get_entity,this.engine.lock(),j=this.state.player_id,this.state.exists(j)&&(k=this.state.get_pos(this.id),f=k[0],g=k[1],l=this.state.get_pos(j),o=l[0],p=l[1],b=this._is_alerted,b||(b=this._is_within_sight_range(f,g,o,p)),b?(i=new ROT.Path.AStar(o,p,function(a){return function(b,c){return a.entity.get_through_rubble?!a.state.is_wall(b,c)||a.state.is_rubble(b,c):!a.state.is_wall(b,c)}}(this)),h=[],m=this.state.get_pos(this.id),c=m[0],d=m[1],i.compute(c,d,function(a){return function(a,b){return h.push([a,b])}}(this)),h.length<=this.entity.sight_range&&h.length!==0&&(this._is_alerted=!0),!this._is_alerted||h.length===0?this._move_randomly():h.length===2?this._attack(h):(a=(n=this.state).general_direction.apply(n,[this.id].concat(e.call(h[1]))),this._move(a))):this._move_randomly()),this.done(),this.engine.unlock()},b.prototype.alert_by_sound=function(){return this._is_alerted?this._is_alerted=!0:!1},b.prototype._move_randomly=function(){var a;return a=$(["n","ne","e","se","s","sw","w","nw"]).random_element(),this._move(a)},b.prototype._attack=function(a){var b,c;return b=(c=this.state).general_direction.apply(c,[this.id].concat(e.call(a[1]))),ROT.RNG.getUniform()<.2?this._use_skill(b):this._move_or_attack(b)},b.prototype._use_skill=function(a){var b,c,d,e;e=this.state.get_skills(this.id),d=$(e).random_element();if(!d)return;b=get_skill(d.key),c=new b(this.entity,this.state);if(c.target===TARGET_DIR8)return c.run(a);if(c.target===TARGET_NONE)return c.run()},b.prototype._move_or_attack=function(a){return this.execute_action("move_or_attack",a)},b.prototype._move=function(a){return this.execute_action("move",a)},b.prototype._is_within_sight_range=function(a,b,c,d){var e,f,g,h;return f=c-a,g=d-b,f<=this.entity.sight_range&&g<=this.entity.sight_range?(e=f*f+g*g,h=this.entity.sight_range*this.entity.sight_range,e<=h):!1},b}(Actor),register_actor("aggressive",a)}.call(this),function(){var a,b,c=function(a,b){function e(){this.constructor=a}for(var c in b)d.call(b,c)&&(a[c]=b[c]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},d={}.hasOwnProperty;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(a,c,d,e,f){this.engine=d,this.on_update=f,b.__super__.constructor.call(this,a,c,e),this.turn_count=0}return c(b,a),b.prototype.on_act=function(){return this.engine.lock(),this.on_update(),this.turn_count++,this.accept_input=!0},b.prototype.on_key=function(a,b){var c;if(!this.acting)return;c=!1;if(a==="escape")return this.target_mode&&this.state.msg(this.id,"Nevermind."),this._clear_target(),!1;!this.target_mode||this.target_mode===TARGET_NONE?c=this._determine_action(a,b):this.target_mode===TARGET_DIR8?c=this._choose_dir8_and_run(a,b):this.target_mode===TARGET_DIR4?c=this._choose_dir4_and_run(a,b):this.target_mode===TARGET_FOV?c=this._choose_fov_and_run(a,b):this.target_mode===TARGET_RANGE?c=this._choose_range_and_run(a,b):this.target_mode===TARGET_MENU&&(c=this._choose_menu_and_run(a,b)),this.on_update();if(c)return this._end()},b.prototype._determine_action=function(a,b){var c,d,e,f,g,h,i,j,k,l;return f=this._get_direction(a,b),f?(c=get_action("move_or_attack"),d=new c(this.entity,this.state),d.run(f)):a==="d"&&b.shift?(c=get_action("dig"),d=new c(this.entity,this.state),this._send_target_message(d.target),this.target_mode=d.target,this.target_action=d,this.target_cost=0,!1):(c=function(){switch(a){case"space":return get_action("wait");case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"0":return g=parseInt(a)-1,k=this.state.get_skills(this.id),j=k[g],j?c=get_skill(j.key):this.state.msg(this.id,"You don't have that skill yet.")}}.call(this),c?(d=new c(this.entity,this.state),d.target===TARGET_NONE?(e=(h=d.mp)!=null?h:0,e>this.state.get_mp(this.id)?(this.state.msg(this.id,"You don't have enough mp."),!1):(l=d.run(),l&&this.state.remove_mp(this.id,e),l)):(this._send_target_message(d.target),this.target_mode=d.target,this.target_action=d,this.target_cost=(i=d.mp)!=null?i:0,!1)):!1)},b.prototype.on_geas_done=function(){return this.on_update()},b.prototype.after_geas_run=function(){return this.on_update()},b.prototype._choose_dir8_and_run=function(a,b){var c,d;c=this._get_direction(a,b);if(c)return this.target_cost>this.state.get_mp(this.id)?(this.state.msg(this.id,"You don't have enough mp."),this.target_mode&&this._clear_target(),!1):(d=this.target_action.run(c),d?this.state.remove_mp(this.id,this.target_cost):this.target_mode&&this.state.msg(this.id,"Nevermind."),this._clear_target(),d)},b.prototype._choose_dir4_and_run=function(a,b){var c;c=this._get_direction(a,b);if(c&&c.length===1)return this._choose_dir8_and_run(a,b)},b.prototype._choose_fov_and_run=function(a,b){},b.prototype._choose_range_and_run=function(a,b){},b.prototype._choose_menu_and_run=function(a,b){},b.prototype._send_target_message=function(a){switch(a){case TARGET_DIR8:return this.state.msg(this.id,"Use movement keys to choose any direction.");case TARGET_DIR4:return this.state.msg(this.id,"Use movement keys to choose one of the four main directions.");case TARGET_FOV:return this.state.msg(this.id,"Use movement keys to highlight an empty, visible square and press ENTER to confirm.");case TARGET_RANGE:return this.state.msg(this.id,"Use movement keys to any square in range.")}},b.prototype._clear_target=function(){return this.target_mode=null,this.target_action=null,this.target_cost=null},b.prototype._start=function(){return this.engine.lock()},b.prototype._end=function(a){return this.done(a),this.engine.unlock(),this.accept_input=!1},b.prototype._get_direction=function(a,b){var c;switch(a){case"up":case"k":case"num8":return c="n";case"u":case"num9":return c="ne";case"right":case"l":case"num6":return c="e";case"n":case"num3":return c="se";case"down":case"j":case"num2":return c="s";case"b":case"num1":return c="sw";case"left":case"h":case"num4":return c="w";case"y":case"num7":return c="nw"}},b}(Actor),register_actor("player",a)}.call(this),function(){var a,b,c=function(a,b){function e(){this.constructor=a}for(var c in b)d.call(b,c)&&(a[c]=b[c]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a},d={}.hasOwnProperty;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(a){function b(a,c,d,e){this.engine=d,b.__super__.constructor.call(this,a,c,e)}return c(b,a),b.prototype.on_act=function(){return this.engine.lock(),this._move_or_attack(this._random_direction()),this.done(),this.engine.unlock()},b.prototype._random_direction=function(){return $(["n","ne","e","se","s","sw","w","nw"]).random_element()},b.prototype._move_or_attack=function(a){return this.execute_action("move_or_attack",a)},b}(Actor),register_actor("random",a)}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),b.Help=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a){a==null&&(a=[]),this.flags={},$(a).each(function(a){return function(b,c){return a.add_flag(c)}}(this))}return a.prototype.get_flags=function(){return $.map(this.flags,function(a,b){return b})},a.prototype.clear=function(){return this.flags={}},a.prototype.add_flag=function(a){return this.flags[a]=!0},a.prototype.has_flag=function(a){return this.flags.hasOwnProperty(a)},a}(),b.Tile=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b,c){this.width=a,this.height=b,this.num_layers=c,this.layers=[],this.items={},$(this.num_layers).times(function(a){return function(b){return a.layers[b]=[],$(a.height).times(function(c){return a.layers[b][c]=Array(a.width),$(a.width).times(function(d){return a.layers[b][c][d]=null})})}}(this))}return a.prototype.each=function(a){return $(this.height).times(function(b){return function(c){return $(b.width).times(function(b){return a(c,b)})}}(this))},a.prototype.at=function(a,b,c,d){return this.get_tile(a,b,c)===d},a.prototype.exists=function(a,b,c){return this.get_tile(a,b,c)!==null},a.prototype.get_stack=function(a,b){var c,d,e,f;if(this.out_of_bounds(a,b))return[];f=Array(this.num_layers);for(d=c=0,e=this.num_layers-1;c<=e;d=c+=1)f[d]=this.get_tile(a,b,d);return f},a.prototype.get_tile=function(a,b,c){if(this.out_of_bounds(a,b,c))return;return this.layers[c][a][b]},a.prototype.set_tile=function(a,b,c,d){if(this.out_of_bounds(a,b,c))return;return this.layers[c][a][b]=d},a.prototype.swap_tile=function(a,b,c,d,e){var f,g;return f=this.get_tile(a,b,e),g=this.get_tile(c,d,e),this.set_tile(c,d,e,f),this.set_tile(a,b,e,g)},a.prototype.clear_tile=function(a,b,c){return this.set_tile(a,b,c,null)},a.prototype.clear=function(){return $(this.num_layers).times(function(a){return function(b){return a.clear_layer(b)}}(this))},a.prototype.clear_layer=function(a){return $(this.height).times(function(b){return function(c){return $(b.width).times(function(d){return b.layers[a][c][d]=null})}}(this))},a.prototype.set_item=function(a,b,c){return items[a*this.width+b]=c},a.prototype.out_of_bounds=function(a,b,c){var d,e,f;return d=a&&a<0||a>=this.height,e=b&&b<0||b>=this.width,f=c&&c<0||c>=this.num_layers,d||e||f},a}(),b.Map=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.width=a,this.height=b}return a.prototype.run=function(a){var b;return b=ROT.RNG.getPercentage(),b<=50?this.digger=new RoguelikeMapGenerator(this.width,this.height):b<=70?this.digger=new MazeMapGenerator(this.width,this.height):this.digger=new CavernMapGenerator(this.width,this.height),this.digger.build(a)},a}(),b.MapGenerator=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.width=a,this.height=b,this._digger=new ROT.Map.Cellular(this.width-2,this.height-2,{connected:!0}),this._digger.randomize(.4)}return a.prototype.build=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;for(l=b=0,h=this.width-1;b<=h;l=b+=1){i=[0,this.height-1];for(c=0,f=i.length;c<f;c++)m=i[c],a(m,l,WALLS,"wall")}j=[0,this.width-1];for(d=0,g=j.length;d<g;d++){l=j[d];for(m=e=1,k=this.height-2;e<=k;m=e+=1)a(m,l,WALLS,"wall")}return this._digger.create(function(b){return function(b,c,d){return d===1?a(c+1,b+1,WALLS,"wall"):a(c+1,b+1,FLOORS,"floor")}}(this))},a}(),b.CavernMapGenerator=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function b(a,b){this.width=a,this.height=b,this._digger=new ROT.Map.IceyMaze(this.width,this.height,ROT.RNG.getUniformInt(3,8))}var a;return a=10,b.prototype.build=function(a){var b,c,d,e,f,g,h;c=[],this._digger.create(function(a){return function(b,d,e){return c[d*a.width+b]=e}}(this)),this._build_rubble_walls(c),e=[];for(h=b=0,d=this.height-1;b<=d;h=b+=1)e.push(function(){var b,d,e;e=[];for(g=b=0,d=this.width-1;b<=d;g=b+=1)f=c[h*this.width+g],f===1?e.push(a(h,g,WALLS,"wall")):f===2?e.push(a(h,g,WALLS,"rubble")):e.push(a(h,g,FLOORS,"floor"));return e}.call(this));return e},b.prototype._build_rubble_walls=function(a){var b,c,d,e,f,g;for(g=b=1,d=this.height-2;b<=d;g=b+=1)for(f=c=1,e=this.width-2;c<=e;f=c+=1)this._good_to_rubble(a,f,g)&&(a[g*this.width+f]=2);return!0},b.prototype._good_to_rubble=function(b,c,d){var e,f;if(!b[d*this.width+c])return!1;e=function(a){return function(){var e,f,g,h,i,j,k,l,m;i=0;for(e=g=j=c-1,k=c+1;g<=k;e=g+=1)for(f=h=l=d-1,m=d+1;h<=m;f=h+=1){b[f*a.width+e]||i++;if(i>=4)return!0}}}(this);if(e()){f=ROT.RNG.getPercentage();if(f<=a)return!0}return!1},b}(),b.MazeMapGenerator=a}.call(this),function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}};b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function d(a,b){this.width=a,this.height=b,this._good_to_rubble=c(this._good_to_rubble,this),this._digger=new ROT.Map.Rogue(this.width,this.height)}var a,b;return a=30,b=10,d.prototype.build=function(a){var b,c,d,e,f,g,h;c=[],this._digger.create(function(a){return function(b,d,e){return c[d*a.width+b]=e}}(this)),this._build_rubble_walls(c),e=[];for(h=b=0,d=this.height-1;b<=d;h=b+=1)e.push(function(){var b,d,e;e=[];for(g=b=0,d=this.width-1;b<=d;g=b+=1)f=c[h*this.width+g],f===1?e.push(a(h,g,WALLS,"wall")):f===2?e.push(a(h,g,WALLS,"rubble")):e.push(a(h,g,FLOORS,"floor"));return e}.call(this));return e},d.prototype._build_rubble_walls=function(a){var b,c,d,e,f,g;for(g=b=1,d=this.height-2;b<=d;g=b+=1)for(f=c=1,e=this.width-2;c<=e;f=c+=1)this._good_to_rubble(a,f,g)&&(a[g*this.width+f]=2);return!0},d.prototype._good_to_rubble=function(c,d,e){var f,g,h,i,j,k,l,m;f=function(a){return function(b,d){return c[d*a.width+b]}}(this);if(f(d,e))return!1;h=0,i=0,g=!1,m=!0,k=f(d-1,e),l=f(d+1,e);if(l===2||k===2)return!1;!k&&!l?(i++,h+=2):(!k||!l)&&h++,k=f(d,e-1),l=f(d,e+1);if(l===2||k===2)return!1;!k&&!l?(i++,h+=2):(!k||!l)&&h++;if(i!==1||h!==2)return!1;k=f(d-1,e-1),k===2&&(m=!1),k!==1&&(g=!0),k=f(d+1,e-1),k!==1&&(g=!0),k===2&&(m=!1),k=f(d+1,e+1),k!==1&&(g=!0),k===2&&(m=!1),k=f(d-1,e+1),k!==1&&(g=!0),k===2&&(m=!1);if(g){j=ROT.RNG.getPercentage();if(m&&j<=a)return!0;if(j<=b)return!0}return!1},d}(),b.RoguelikeMapGenerator=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function b(a,b,c){this.title=a,this.cb=c,this.make_choices(b)}var a;return a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",b.prototype.make_choices=function(b){return this.choices=[],this.choice_map={},$.each(b,function(b){return function(c,d){return b.choices.push([a[c],d]),b.choice_map[a[c]]=d}}(this))},b.prototype.on_key=function(a,b){return b.shift&&(a=a.toUpperCase()),this.choose(a)},b.prototype.choose=function(a){if(this.choice_map[a])return this.cb(this.choice_map[a])},b}(),b.Menu=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a){this.lines=a}return a}(),b.Output=a}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k;k=typeof exports!="undefined"&&exports!==null?exports:this,i=0,b=1,j=2,a=3,f=4,e=7,h={n:"ne",ne:"e",e:"se",se:"s",s:"sw",sw:"w",w:"nw",nw:"n"},d={n:"nw",ne:"n",e:"ne",se:"e",s:"se",sw:"s",w:"sw",nw:"w"},g={n:"s",ne:"sw",e:"w",se:"nw",s:"n",sw:"ne",w:"e",nw:"se"},c=function(){function c(a,b){this.map_width=a,this.map_height=b,this._map=new Map(this.map_width,this.map_height,f),this.floor=0,this._player_generator=new PlayerGenerator,this._monster_generator=new MonsterGenerator,this._cave_generator=new MapGenerator(this.map_width,this.map_height),this.clear_map(),this.exit_locked=!0,this._entities={},this.output=[],this.actors={},this._player_fov_map={},this._gold_map={},this._potions_map={}}return c.prototype.generate_player=function(a,b,c){return this._player=this._player_generator.generate(a,b,c),this.player_id=this._player.id,this._add(this._player),this._player},c.prototype.generate_monster=function(a){var b;return b=this._monster_generator.generate(a,this.floor),this._add(b),b},c.prototype.generate_cave=function(){return this.clear_map(),this._cave_generator.run(function(a){return function(b,c,d,e){return a._map.set_tile(b,c,d,e)}}(this))},c.prototype.generate_items=function(){},c.prototype.next_floor=function(){return this.floor+=1},c.prototype.clear_map=function(){return this._map.clear(),this._gold_map={},this._potions_map={}},c.prototype.clear_monsters=function(){return this.each_monster(function(a){return function(b){return a.remove(b)}}(this))},c.prototype.clear_output=function(){return this.output=[]},c.prototype.add_trigger=function(a,b,c){return this._map.set_tile(a,b,i,c)},c.prototype.get_trigger=function(a,b){return this._map.get_tile(a,b,i)},c.prototype.add_entrance=function(a,c){return this._map.set_tile(a,c,b,"entrance")},c.prototype.get_entrances=function(){return this._find_spaces(function(a){return function(b,c){return a.is_entrance(b,c)}}(this))},c.prototype.add_exit=function(a,c){return this._map.set_tile(a,c,b,"exit"),this.exit_locked=!0},c.prototype.get_exits=function(){return this._find_spaces(function(a){return function(b,c){return a.is_exit(b,c)}}(this))},c.prototype.register_actor=function(a,b){return this.actors[a]=b},c.prototype.unregister_actor=function(a){return delete this.actors[a]},c.prototype.get_actor=function(a){return this.actors[a]},c.prototype.each_creature=function(a){return $.each(this._entities,function(b){return function(b,c){return a(c.id)}}(this))},c.prototype.each_monster=function(a){return $.each(this._entities,function(b){return function(c,d){if(d.id!==b.player_id)return a(d.id)}}(this))},c.prototype.each_tile=function(a){return this._map.each(a)},c.prototype.exists=function(a){return!!this._entities[a]},c.prototype.get_pos=function(a){return this._entities[a].pos()},c.prototype.get_attack=function(a){return this._entities[a].attack},c.prototype.get_hp=function(a){return this._entities[a].hp},c.prototype.get_max_hp=function(a){return this._entities[a].max_hp},c.prototype.get_mp=function(a){return this._entities[a].mp},c.prototype.get_max_mp=function(a){return this._entities[a].max_mp},c.prototype.get_race=function(a){return this._entities[a].race},c.prototype.get_class=function(a){return this._entities[a]["class"]},c.prototype.get_gender=function(a){return this._entities[a].gender},c.prototype.get_speed=function(a){return this._entities[a].speed},c.prototype.get_level=function(a){return this._entities[a].level},c.prototype.get_short_description=function(a){return this._entities[a].short_description},c.prototype.get_skills=function(a){return this._entities[a].skills},c.prototype.at_max_hp=function(a){return this.get_hp(a)===this.get_max_hp(a)},c.prototype.at_max_mp=function(a){return this.get_mp(a)===this.get_max_mp(a)},c.prototype.is_dead=function(a){return this._entities[a].dead},c.prototype.is_blocked=function(a,b){return this.is_wall(a,b)||this.is_creature(a,b)},c.prototype.is_creature=function(b,c){return this._map.exists(b,c,a)},c.prototype.is_wall=function(a,b){return this._map.exists(a,b,j)},c.prototype.is_rubble=function(a,b){return this._map.at(a,b,j,"rubble")},c.prototype.is_entrance=function(a,c){return this._map.at(a,c,b,"entrance")},c.prototype.is_exit=function(a,c){return this._map.at(a,c,b,"exit")},c.prototype.get_data=function(a,b){return this._map.get_stack(a,b)},c.prototype.is_blocked_in_dir=function(a,b,c){var d,e,f;return f=this.get_adjacent(a,b,c),d=f[0],e=f[1],this.is_blocked(d,e)},c.prototype.is_creature_in_dir=function(a,b,c){var d,e,f;return f=this.get_adjacent(a,b,c),d=f[0],e=f[1],this.is_creature(d,e)},c.prototype.monster_count=function(){var a;return a=0,this.each_monster(function(b){return a+=1}),a},c.prototype.get_by_pos=function(a,b){var c;return c=null,$.each(this._entities,function(d,e){if(e.x===a&&e.y===b)return c=e.id}),c},c.prototype.get_closest_creature=function(a,b){var c,d,e,f,g,h,i;return b==null&&(b={}),h=this.get_pos(a),e=h[0],f=h[1],g=(i=b.range)!=null?i:999,c=null,d=null,this.each_monster(function(a){return function(b){var h,i,j,k;k=a.get_pos(b),i=k[0],j=k[1],h=a.get_distance(e,f,i,j);if(h<=g&&(!c||h<d))return c=b,d=h}}(this)),c},c.prototype.get_nearby_creatures=function(a,b){var c,d,e,f,g,h,i;return b==null&&(b={}),h=this.get_pos(a),c=h[0],d=h[1],f=(i=b.range)!=null?i:999,g=f*f,e=[],this.each_monster(function(a){return function(b){var f,h,i,j;if(b===a.player_id)return;j=a.get_pos(b),h=j[0],i=j[1],f=a.get_euclid_distance_sq(c,d,h,i);if(f<=g)return e.push(a.get_actor(b))}}(this)),e},c.prototype.find_in_direction=function(a,b,c,d){var e,f,g,h,i;h=this._offset_by_dir(c),f=h[0],g=h[1],e=0;for(;;){if(d(a,b,e))return[a,b];i=[a+f,b+g],a=i[0],b=i[1],e+=1}},c.prototype.pos_in_direction=function(a,b,c,d){var e,f,g;return d==null&&(d=1),g=this._offset_by_dir(c),e=g[0],f=g[1],[a+e*d,b+f*d]},c.prototype.get_distance=function(a,b,c,d){return Math.abs(c-a)+Math.abs(d-b)},c.prototype.get_euclid_distance_sq=function(a,b,c,d){var e,f;return e=c-a,f=d-b,e*e+f*f},c.prototype.get_adjacent_pos=function(a,b){var c,d,e;return e=this.get_pos(a),c=e[0],d=e[1],this.get_adjacent(c,d,b)},c.prototype.get_adjacent=function(a,b,c){var d,e,f;return f=this._offset_by_dir(c),d=f[0],e=f[1],[a+d,b+e]},c.prototype.get_all_adjacent_pos=function(a,b){var c;return c=[],$.each([-1,0,1],function(d){return function(d,e){return $.each([-1,0,1],function(d,f){if(e!==0||f!==0)return c.push([a+e,b+f])})}}(this)),c},c.prototype.get_adjacent_positions=function(a){return this.get_all_adjacent_pos.apply(this,this.get_pos(a))},c.prototype.general_direction=function(a,b,c){var d,e,f;return f=this.get_pos(a),d=f[0],e=f[1],this._dir_by_offset(b-d,c-e)},c.prototype.rotate_right=function(a){return h[a]},c.prototype.rotate_left=function(a){return d[a]},c.prototype.flip_dir=function(a){return g[a]},c.prototype.random_empty_space=function(){return this._random_space(function(a){return function(b,c){return!a.is_blocked(b,c)}}(this))},c.prototype.msg=function(a,b){var c,d;if(a===this.player_id)return c=this.output.length-(e-1),c>0&&(this.output=this.output.slice(c)),d=this.get_actor(this.player_id),this.output.push({turn_count:d.turn_count,message:b})},c.prototype.shout_by=function(a,b){if(a===this.player_id)return;return this.msg(this.player_id,b)},c.prototype.set_pos=function(b,c,d){var e,f,g;return g=this._entities[b].pos(),e=g[0],f=g[1],this._map.clear_tile(e,f,a),this._entities[b].set_pos(c,d),this._map.set_tile(c,d,a,this._entities[b])},c.prototype.damage=function(a,b){var c;c=this._entities[a],c.hp-=b;if(c.hp<=0)return c.hp=0,c.dead=!0},c.prototype.remove_mp=function(a,b){var c;c=this._entities[a],c.mp-=b;if(c.mp<=0)return c.mp=0},c.prototype.remove=function(b){var c,d,e;return e=this._entities[b].pos(),c=e[0],d=e[1],delete this._entities[b],this._map.clear_tile(c,d,a)},c.prototype.set_off_triggers=function(a){var b,c,d,e;d=this.get_pos(a),b=d[0],c=d[1],e=this.get_trigger(b,c);if(e)return e(a)},c.prototype.give_skill=function(a,b){var c;c=this._entities[a],c.add_skill(b);if(a===this.player_id)return SoundEffects.get().play_skill_gained()},c.prototype.unlock_exit=function(){return this.exit_locked=!1},c.prototype.restore_hp=function(a,b){var c;c=this._entities[a];if(!c)return;c.hp+=b,c.hp>c.max_hp&&(c.hp=c.max_hp);if(a===this.player_id)return SoundEffects.get().play_restore_hp()},c.prototype.restore_mp=function(a,b){var c;c=this._entities[a];if(!c)return;c.mp+=b,c.mp>c.max_mp&&(c.mp=c.max_mp);if(a===this.player_id)return SoundEffects.get().play_restore_mp()},c.prototype.grant_xp=function(a,b){var c;c=this._entities[a];if(!c)return;c.xp+=b;if(c.xp>=1){c.level_up(),this.msg(a,"You leveled up!");if(a===this.player_id)return SoundEffects.get().play_level_up()}},c.prototype.grant_gold=function(a,b){var c;c=this._entities[a];if(c&&b){c.gold+=b;if(a===this.player_id)return this.msg(a,"You collect $"+b+" worth of gold!"),SoundEffects.get().play_coin()}},c.prototype.get_player_sight_range=function(){return this._player.sight_range},c.prototype.remove_rubble=function(a,c){var d,e,f,g;d=5,e=10+10*(this.floor-1)*.2,f=e/4;if(this.is_rubble(a,c)){this._map.clear_tile(a,c,j),this._map.set_tile(a,c,b,"floor");if(ROT.RNG.getPercentage()<=d)return g=RNG.clampedNormal(e,f),this.put_gold(a,c,g)}},c.prototype.make_rubble=function(a,b){if(this.is_wall(a,b))return this._map.set_tile(a,b,j,"rubble")},c.prototype.clear_player_fov_map=function(){return this._player_fov_map={}},c.prototype.get_player_fov_map=function(){return this._player_fov_map},c.prototype.is_visible_to_player=function(a,b){return this._player_fov_map[a*this.map_width+b]},c.prototype.put_potion=function(a,b,c){var d;return d=this._hash_map_key(a,b),this._potions_map[d]=c},c.prototype.pickup_potion=function(a,b,c){var d,e,f,g;e=this._entities[c];if(!e)return;f=this._hash_map_key(a,b);if(f in this._potions_map&&this._potions_map[f]){g=this._potions_map[f],d=RNG.clampedNormal(8+8*(this.floor-1)*.1,2);if(g==="hp"){if(e.hp<e.max_hp)return this.msg(c,"You drink the health potion, a warm healing feeling washes over you!"),this.restore_hp(e.id,d),delete this._potions_map[f]}else if(e.mp<e.max_mp)return this.msg(c,"You drink the magic potion, your toes tingle!"),this.restore_mp(e.id,d),delete this._potions_map[f]}},c.prototype.get_potion=function(a,b){var c;return c=this._hash_map_key(a,b),c in this._potions_map?this._potions_map[c]:void 0},c.prototype.put_gold=function(a,b,c){var d,e;if(c)return e=this._hash_map_key(a,b),(d=this._gold_map)[e]==null&&(d[e]=0),this._gold_map[e]+=c},c.prototype.pickup_gold=function(a,b,c){var d,e,f;d=this._entities[c];if(d){f=this._hash_map_key(a,b),e=this._gold_map[f],d.gold+=e,delete this._gold_map[f];if(c===this.player_id)return this.msg(c,"You pick up $"+e+" worth of gold!"),SoundEffects.get().play_coin()}},c.prototype.has_gold=function(a,b){var c;return c=this._hash_map_key(a,b),c in this._gold_map},c.prototype._hash_map_key=function(a,b){return a*this.map_width+b},c.prototype._add=function(a){return this._entities[a.id]=a,a.id},c.prototype._random_space=function(a){var b;return b=this._find_spaces(a),$(b).random_element()},c.prototype._find_spaces=function(a){var b;return a==null&&(a=function(){return!0}),b=[],this._map.each(function(c){return function(c,d){if(a(c,d))return b.push([c,d])}}(this)),b},c.prototype._offset_by_dir=function(a){switch(a){case"n":return[-1,0];case"ne":return[-1,1];case"e":return[0,1];case"se":return[1,1];case"s":return[1,0];case"sw":return[1,-1];case"w":return[0,-1];case"nw":return[-1,-1];default:throw new Error("Unrecognized direction: "+a)}},c.prototype._dir_by_offset=function(a,b){var c,d;return a>0?d="s":a===0?d="":d="n",b>0?c="e":b===0?c="":c="w",""+d+c},c}(),k.GameState=c,k.FLOORS=b,k.WALLS=j,k.CREATURES=a,k.TRIGGERS=i}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){}return a}(),b.Status=a}.call(this),function(){var a,b,c=[].slice;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(){this.state=new GameState(80,24),this.update_callbacks=[],this.scheduler=new ROT.Scheduler.Action,this.engine=new ROT.Engine(this.scheduler)}return a.prototype.on_key=function(){var a,b,d;a=1<=arguments.length?c.call(arguments,0):[];if(this.menu)return(b=this.menu).on_key.apply(b,a);if(this.player_actor)return(d=this.player_actor).on_key.apply(d,a)},a.prototype.start=function(){return this.prompt_character()},a.prototype.prompt_character=function(){return this.prompt_gender(function(a){return function(b){return a.prompt_race(function(c){return a.prompt_class(c,function(d){return a.create_player(b,c,d),a.new_floor()})})}}(this))},a.prototype.prompt_gender=function(a){return this.show_menu(new Menu("Choose your gender: ",list_genders(),function(b){return function(c){return b.show_menu(null),a(c)}}(this)))},a.prototype.prompt_race=function(a){return this.show_menu(new Menu("Choose your race: ",list_races({player:!0}),function(b){return function(c){return b.show_menu(null),a(c)}}(this)))},a.prototype.prompt_class=function(a,b){return this.show_menu(new Menu("Choose your class: ",list_classes_for_race(a.key),function(a){return function(c){return a.show_menu(null),b(c)}}(this)))},a.prototype.show_menu=function(a){return this.menu=a,this.update()},a.prototype.create_player=function(a,b,c){var d,e;return e=this.state.generate_player(a,b,c),this.player_id=e.id,d=get_actor("player"),this.player_actor=new d(e,this.scheduler,this.engine,this.state,function(a){return function(){return a.update()}}(this)),this.scheduler.add(this.player_actor,!0,0),this.state.register_actor(this.player_id,this.player_actor),this.player_actor.on_remove(function(a){return function(){return a.state.msg(a.player_id,"GAME OVER!"),a.update(),a.scheduler.clear(),a.state.unregister_actor(a.player_id),a.player_actor=null}}(this)),this.engine.start()},a.prototype.on_update=function(a){return this.update_callbacks.push(a),a()},a.prototype.update=function(){return $.each(this.update_callbacks,function(){return this()})},a.prototype.new_floor=function(){var a,b,c,d;return this.state.next_floor(),this.state.generate_cave(),c=this.state.random_empty_space(),a=c[0],b=c[1],this.state.add_entrance(a,b),this.state.set_pos(this.player_id,a,b),this._generate_enemies(),this._generate_gold(),this._generate_potions(),d=this.state.random_empty_space(),a=d[0],b=d[1],this.state.add_exit(a,b),this.state.add_trigger(a,b,function(a){return function(b){if(b===a.state.player_id)return a.state.exit_locked?a.state.msg(a.player_id,"The exit is locked. You must find and defeat the boss of this level to proceed."):(SoundEffects.get().play_descend(),a.new_floor())}}(this)),this.map_ready=!0,this.update()},a.prototype._generate_gold=function(){var a,b,c,d,e,f;return b=4,c=1.5,a=40,f=RNG.clampedNormal(b,c),d=a,d+=d*(this.state.floor-1)*.2,e=d/3,$(f).times(function(a){return function(){var b,c,f,g;return g=a.state.random_empty_space(),c=g[0],f=g[1],b=RNG.clampedNormal(d,e),a.state.put_gold(c,f,b)}}(this))},a.prototype._generate_potions=function(){var a,b,c,d;return b=3,c=.75,a=70,d=RNG.clampedNormal(b,c),$(d).times(function(b){return function(){var c,d,e,f;return e=b.state.random_empty_space(),c=e[0],d=e[1],f=ROT.RNG.getPercentage()<=a?"hp":"mp",b.state.put_potion(c,d,f)}}(this))},a.prototype._generate_enemies=function(){var a,b;return a=RNG.clampedNormal(10,1),b=RNG.clampedNormal(4,1),$(a).times(function(a){return function(){return a._generate_trash()}}(this)),$(b).times(function(a){return function(){return a._generate_uncommon()}}(this)),this._generate_boss()},a.prototype._generate_trash=function(){var a,b,c,d;return a=this.state.generate_monster("trash"),this._make_actor(a,function(b){return function(){return b._grant_kill_bonuses(a),b.update()}}(this)),b=this.state.random_empty_space(),c=b[0],d=b[1],this.state.set_pos(a.id,c,d)},a.prototype._generate_uncommon=function(){var a,b,c,d;return a=this.state.generate_monster("uncommon"),this._make_actor(a,function(b){return function(){return b._grant_kill_bonuses(a),b.update()}}(this)),b=this.state.random_empty_space(),c=b[0],d=b[1],this.state.set_pos(a.id,c,d)},a.prototype._generate_boss=function(){var a,b,c,d;return a=this.state.generate_monster("rare"),this._make_actor(a,function(b){return function(){return b._grant_kill_bonuses(a),b._grant_skill(),b.state.unlock_exit(),b.state.msg(b.player_id,"You hear a loud CLANK in the distance. (Do you dare delve deeper?)"),SoundEffects.get().play_clank(),b.update()}}(this)),b=this.state.random_empty_space(),c=b[0],d=b[1],this.state.set_pos(a.id,c,d)},a.prototype._grant_kill_bonuses=function(a){return this._surge(a.surge_grant_chance),this._grant_gold(a.gold),this._grant_xp(a.kill_xp),this._check_full_surge()},a.prototype._grant_skill=function(){var a,b,c,d,e;e=this.state.get_skills(this.player_id),a=list_skill_keys(),d={},_.each(e,function(a){return d[a.key]=!0}),c=[],_.each(a,function(a){if(!d[a])return c.push(a)});if(c.length===0)return;return b=$(c).random_element(),this.state.msg(this.player_id,"You learn "+b+"!"),this.state.give_skill(this.player_id,b)},a.prototype._surge=function(a){var b;if(ROT.RNG.getPercentage()<=a)return b=ROT.RNG.getPercentage(),b<=50?this._health_surge():this._magic_surge();return},a.prototype._check_full_surge=function(){if(this.state.monster_count()===0)return this._full_surge()},a.prototype._full_surge=function(){return this.state.restore_hp(this.player_id,this.state.get_max_hp(this.player_id)),this.state.restore_mp(this.player_id,this.state.get_max_mp(this.player_id)),this.state.msg(this.player_id,"With all the enemies vanquished, you are able to rest. Health and magic restored.")},a.prototype._health_surge=function(){var a,b,c;return a=10,a+=a*(this.state.floor-1)*.1,b=a/4,c=RNG.clampedNormal(a,b),this.state.restore_hp(this.player_id,c)},a.prototype._magic_surge=function(){var a,b,c;return a=6,a+=a*(this.state.floor-1)*.1,b=a/4,c=RNG.clampedNormal(a,b),this.state.restore_mp(this.player_id,c)},a.prototype._grant_xp=function(a){return this.state.grant_xp(this.player_id,a)},a.prototype._grant_gold=function(a){return this.state.grant_gold(this.player_id,a)},a.prototype._make_actor=function(a,b){var c,d;return b==null&&(b=function(){}),c=get_actor("aggressive"),d=new c(a,this.scheduler,this.engine,this.state),this.scheduler.add(d,!0,0),this.state.register_actor(a.id,d),d.on_remove(function(c){return function(){return c.scheduler.remove(d),c.state.unregister_actor(a.id),b()}}(this))},a}(),b.Game=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function c(a,b,c){this.parent=a,this.overlay=b,this.game=c}var a,b;return b="high_score",a=730,c.prototype.update=function(){var c,d,e,f,g;f=this.game.state,d=f._player;if(!d||f.exists(d.id)){this.parent.html(""),this.parent.hide(),this.overlay.hide();return}return this.parent.show(),this.overlay.show(),e=$.cookie(b),e==null&&(e=0),c=d.gold,e<c&&(e=c,$.cookie(b,c,{expires:a})),g="<div class='title'>REST IN PIECES</div><div class='content'>"+("GOLD: <b>$"+c+"</b><br/><br/>")+("HIGHSCORE: <b>$"+e+"</b><br/><br/>")+("You were a <b>"+d.race.name+" "+d["class"].name+"</b>.<br /><br />")+("Your corpse decorates Floor <b>"+f.floor+"</b>.<br /><br />")+("You were level <b>"+d.level+"</b>.<br />")+("You knew <b>"+d.skills.length+"</b> skills.<br />")+"<br />"+"<br />"+"<br />"+"<a href='#' id='restart_link'>RESTART</a>","</div>",this.parent.html(g),$("#restart_link").click(function(a){return function(){return location.reload()}}(this)),SoundEffects.get().play_death()},c}(),b.GameOverPresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a){this.game=a,this.map_presenter=new MapPresenter($("#map"),this.game),this.help_presenter=new HelpPresenter($("#help"),this.game),this.skills_presenter=new SkillsPresenter($("#skills"),this.game),this.points_presenter=new PointsPresenter($("#points"),this.game),this.output_presenter=new OutputPresenter($("#output"),this.game),this.status_presenter=new StatusPresenter($("#status"),this.game),this.menu_presenter=new MenuPresenter($("#menu"),$("#menu_title"),$("#menu_content"),$("#menu_overlay"),this.game),this.game_over_presenter=new GameOverPresenter($("#game_over"),$("#game_over_overlay"),this.game)}return a.prototype.update=function(){return this.map_presenter.update(),this.skills_presenter.update(),this.points_presenter.update(),this.output_presenter.update(),this.status_presenter.update(),this.menu_presenter.update(),this.game_over_presenter.update()},a}(),b.GamePresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.parent=a,this.game=b,this.one_time=!1,this.parent.html("Move: <br />&nbsp;&nbsp;* <b>arrow keys, num pad, or</b><br />&nbsp;&nbsp;* <b>hjkl</b> and <b>yubn</b><br /><br />Dig (walls or rubble): <b>D</b><br /><br />Wait: <b>space</b><br /><br />Skills: <b>1-9</b> and <b>0</b><br /><br />GOALS:<br />&nbsp;&nbsp;* collect <b>gold</b><br />&nbsp;&nbsp;* <b>kill the boss</b> to go down<br />&nbsp;&nbsp;* use your <b>skills</b><br />&nbsp;&nbsp;* enemies may grant <b>healing</b><br />&nbsp;&nbsp;* kill all enemies for a <b>full heal</b><br />")}return a}(),b.HelpPresenter=a}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l=function(a,b){return function(){return a.apply(b,arguments)}};k=typeof exports!="undefined"&&exports!==null?exports:this,d={empty:{rep:" ",color:[0,0,0]},floor:{rep:".",color:[51,51,51]},entrance:{rep:"<",color:[80,80,80]},exit:{rep:">",color:[0,255,255]}},j={wall:{rep:"#",color:[102,102,102]},rubble:{rep:"*",color:[190,190,190]}},b={player:"@",angel:"a",catfolk:"c",centaur:"C",demon:"d",dragon:"D",dragonkin:"k",dwarf:"w",elf:"e",gnome:"g",giant:"G",hobbit:"i",human:"h",shapeshifter:"s",werewolf:"w",vampire:"V"},a={player:[255,255,255],trash:[80,80,50],uncommon:[80,50,255],rare:[255,0,0]},f="$",e=[255,223,0],i="!",h={hp:[255,0,0],mp:[80,50,255]},c=!1,g=function(){function g(a,b){var c;this.parent=a,this.data_parent=b,this._reflectivity=l(this._reflectivity,this),this._light_passes=l(this._light_passes,this),this.state=this.data_parent.state,c=this.parent.css("font-family"),c==null&&(c="monospace"),this.display=new ROT.Display({width:this.state.map_width,height:this.state.map_height,fontSize:14,fontFamily:c,bg:"#000000",layout:"rect"}),this.parent.append(this.display.getContainer()),this._prev_seen={},this._prev_seen_floor=this.state.floor}return g.prototype._light_passes=function(a,b){return!this.state.is_wall(a,b)},g.prototype._reflectivity=function(a,b){return this.state.is_wall(a,b)?0:1},g.prototype.update=function(){var a,b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;if(!this.data_parent.map_ready){this.parent.hide();return}w=this.data_parent.state,this.parent.show(),this.display.clear(),m={},this.state.clear_player_fov_map(),h=this.state.get_player_fov_map(),p=w.player_id;if(!this.state.exists(p))return;t=w.get_pos(p),n=t[0],o=t[1],i=w.map_height,x=w.map_width,a=new ROT.FOV.PreciseShadowcasting(this._light_passes,{topology:8}),d=new ROT.Lighting(this._reflectivity,{range:4,passes:1}),a.compute(n,o,w.get_player_sight_range(),function(a,b,c,d){return h[a*x+b]=d}),b=new ROT.FOV.PreciseShadowcasting(this._light_passes,{topology:4}),d.setFOV(b),d.setLight(n,o,[255,255,255]),d.compute(function(a,b,c){return m[a*x+b]=c}),e=[200,200,200],r=[130,130,130],this._prev_seen_floor!==this.state.floor&&(this._prev_seen={},this._prev_seen_floor=this.state.floor);if(c){for(z=j=0,u=i-1;j<=u;z=j+=1)for(y=k=0,v=x-1;k<=v;y=k+=1)s=this._generate_rep(y,z),f=s.color,l=e,q=z*x+y,m[q]&&(l=ROT.Color.add(l,m[q])),g=ROT.Color.multiply(f,l),this.display.draw(y,z,s.rep,ROT.Color.toRGB(g));return}return $.each(this._prev_seen,function(a){return function(b){if(!(b in h))return y=b%x,z=(b-y)/x,s=a._generate_rep(y,z,{prev_seen:!0}),f=s.color,g=ROT.Color.multiply(f,r),a.display.draw(y,z,s.rep,ROT.Color.toRGB(g))}}(this)),$.each(h,function(a){return function(b){return a._prev_seen[b]=1,y=b%x,z=(b-y)/x,s=a._generate_rep(y,z),f=s.color,l=e,m[b]&&(l=ROT.Color.add(l,m[b])),g=ROT.Color.multiply(f,l),a.display.draw(y,z,s.rep,ROT.Color.toRGB(g))}}(this))},g.prototype._generate_rep=function(c,g,k){var l,m,n,o,p,q;q=this.state.get_data(g,c),p=null;if(!k||!k.prev_seen)if(q[CREATURES]){l=q[CREATURES],m=l.id===this.state.player_id,n=m?"player":l.race.key,p={rep:b[n],color:a[l.rarity]};if(!p.rep||!p.color)throw new Error("Could not find rep for '"+n+"'")}else if(this.state.has_gold(g,c))p={rep:f,color:e};else if(o=this.state.get_potion(g,c))p={rep:i,color:h[o]};if(!p)if(q[WALLS]){p=j[q[WALLS]];if(!p)throw new Error("Could not find rep for '"+q[WALLS]+"'")}else if(q[FLOORS]){p=d[q[FLOORS]];if(!p)throw new Error("Could not find rep for '"+q[FLOORS]+"'")}else p=d.empty;return p},g}(),k.MapPresenter=g}.call(this),function(){var a,b,c=[].slice;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function b(a,b,c,d,e){this.parent=a,this.title=b,this.content=c,this.overlay=d,this.menu_parent=e}var a;return a={base_hp:"Hit Points (HP)",base_mp:"Magic Points (MP)",base_speed:"Speed",base_attack:"Attack",base_sight_range:"Sight Range"},b.prototype.update=function(){var a;return a=this.menu_parent.menu,a?(this.show_menu(!0),this.title.html(a.title),this.content.html(this.make_choices(a,a.choices))):this.show_menu(!1)},b.prototype.show_menu=function(a){return a==null&&(a=!0),a?($(this.parent).show(),$(this.overlay).show()):($(this.parent).hide(),$(this.overlay).hide())},b.prototype.make_choices=function(a,b){var d;return d=[],$.each(b,function(b){return function(e,f){return d.push(b.make_choice.apply(b,[a].concat(c.call(f))))}}(this)),d},b.prototype.make_choice=function(a,b,c){var d,e,f;return e=$("<div/>",{"class":"menu_option",id:"option_"+b}),e.html(b+": "),d=$("<a/>",{href:"#"}).html(c.name),d.click(function(){return a.choose(b)}),e.append(d),f=this._get_tip_content(c),e.miniTip({title:_.str.capitalize(c.name),content:f,anchor:"w",maxW:"350px"})},b.prototype._get_tip_content=function(b){var c,d,e,f,g;c="";for(d in b)g=b[d],a.hasOwnProperty(d)&&(e=a[d],f=g>=0?"+":"",c+=e+":&nbsp;&nbsp;"+f+g+"<br/>");return c},b}(),b.MenuPresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.parent=a,this.game=b}return a.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j;j=this.game.state,f=j.output,this.parent.html(""),g=this.game.player_actor;if(!g)return;b=g.turn_count,i=[];for(d=e=h=f.length-1;e>=0;d=e+=-1)c=f[d],a="entry",b===c.turn_count?d===f.length-1&&(a="newestEntry"):a="oldEntry",i.push(this.parent.append($("<div/>",{"class":a}).html(c.message)));return i},a}(),b.OutputPresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){var c;this.parent=a,this.game=b,c="&nbsp;&nbsp;&nbsp;&nbsp;",this.hp=$("<b/>",{id:"hp"}).html("0 / 0"),this.hp_bar=$("<b/>",{id:"hp_bar"}),this.parent.append("HP: ").append(this.hp).append(" ").append(this.hp_bar).append(c),this.mp=$("<b/>",{id:"mp"}).html("0 / 0"),this.mp_bar=$("<b/>",{id:"mp_bar"}),this.parent.append("MP: ").append(this.mp).append(" ").append(this.mp_bar).append(c),this.xp=$("<b/>",{id:"xp"}).html("0%"),this.xp_bar=$("<b/>",{id:"xp_bar"}),this.parent.append("XP: ").append(this.xp).append(" ").append(this.xp_bar)}return a.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j;i=this.game.state,h=i._player;if(!h)return;return j=_.str.numberFormat(h.xp*100,0),g=this._nbsp_pad(j+"%",5),this.xp.html(g),this.xp_bar.html(this._bar("xp",h.xp,15)),a=h.hp/h.max_hp,b=h.hp+" / "+h.max_hp,e=this._nbsp_pad(b,8),this.hp.html(e),this.hp_bar.html(this._bar("hp",a,15)),c=h.mp/h.max_mp,d=h.mp+" / "+h.max_mp,f=this._nbsp_pad(d,8),this.mp.html(f),this.mp_bar.html(this._bar("mp",c,15))},a.prototype._nbsp_pad=function(a,b){return _.str.rpad(a,b,"&").replace(/&/g,"&nbsp;")},a.prototype._bar=function(a,b,c){var d,e,f,g;return e=Math.round(b*(c-2)),f=c-2-e,d=_.str.repeat("=",e),g=_.str.repeat("-",f),"<span class='bar "+a+"'><span class='filled'>|"+d+"<span class='empty'>"+g+"</span>|</span></span>"},a}(),b.PointsPresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.parent=a,this.game=b,this.skills=[],this.skill_costs=[],this.lastNewSkill=0,this.lastNewSkillTime=0,$(10).times(function(a){return function(b){var c,d,e,f;return c=$("<span/>",{"class":"cost"}),c.append(" ("),e=$("<span/>",{id:"skill_"+b+"_cost"}).html("0 mp"),c.append(e),c.append(")"),d=$("<div />",{"class":"skill"}),d.append((b+1)%10+": "),f=$("<span/>",{id:"skill_"+b,"class":"disabled"}).html("none"),d.append(f),d.append(c),a.parent.append(d),a.skills.push(f),a.skill_costs.push(e)}}(this))}return a.prototype.update=function(){var a,b,c,d;d=this.game.state,b=d._player;if(!b)return;return c=b.skills,a=c.length,$(10).times(function(a){return function(d){var e,f;return f=c[d],f?(a.skills[d].removeClass("disabled"),d>a.lastNewSkill&&(a.skills[d].addClass("new"),e=(new Date).getTime(),a.lastNewSkillTime===0&&(a.lastNewSkillTime=e),e-a.lastNewSkillTime>1e4&&(a.skills[d].removeClass("new"),a.lastNewSkillTime=0,a.lastNewSkill=c.length)),a.skills[d].html(f.name),f.mp>b.mp?a.skill_costs[d].addClass("invalid"):a.skill_costs[d].removeClass("invalid"),a.skill_costs[d].html(f.mp+" mp")):(a.skills[d].addClass("disabled"),a.skills[d].html("none"),a.skill_costs[d].removeClass("invalid"),a.skill_costs[d].html("0 mp"))}}(this))},a}(),b.SkillsPresenter=a}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=function(){function a(a,b){this.parent=a,this.game=b,this.level=$("<span/>",{id:"level"}).append("0"),this.race=$("<span/>",{id:"race"}).append(""),this["class"]=$("<span/>",{id:"class"}).append("unknown"),this.gold=$("<span/>",{id:"gold"}).html(0),this.parent.append("Lvl ").append(this.level).append(" ").append(this.race).append(" ").append(this["class"]).append("<br/><br/>GOLD ").append(this.gold).append("<br/><br/>"),this.floor=$("<span/>",{id:"floor"}).html(0),this.exit_locked=$("<span/>",{id:"exit_locked"}).html(0),this.parent.append("FLOOR ").append(this.floor).append("&nbsp;&nbsp;&nbsp;").append(this.exit_locked)}return a.prototype.update=function(){var a,b;b=this.game.state,a=b._player;if(!a)return;return this.level.html(a.level),this.race.html(a.race.name),this["class"].html(a["class"].name),this.floor.html(b.floor),this.exit_locked.html(b.exit_locked?"Exit locked":"Exit unlocked!"),this.gold.html("$"+a.gold)},a.prototype._nbsp_pad=function(a,b){return _.str.rpad(a,b,"&").replace(/&/g,"&nbsp;")},a.prototype._bar=function(a,b,c){var d,e,f,g;return e=Math.round(b*(c-2)),f=c-2-e,d=_.str.repeat("=",e),g=_.str.repeat("-",f),"<span class='bar "+a+"'><span class='filled'>|"+d+"<span class='empty'>"+g+"</span>|</span></span>"},a}(),b.StatusPresenter=a}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l;l=typeof exports!="undefined"&&exports!==null?exports:this,e=function(){var a;return a=$("<div/>",{id:"map","class":"map_content"}),$("<div/>",{"class":"map"}).append(a)},k=function(){var a;return a=$("<div/>",{id:"status","class":"content"}),$("<div/>",{"class":"status"}).append(a)},c=function(){var a,b;return b=$("<div/>",{"class":"title"}).html("help"),a=$("<div/>",{id:"help","class":"content"}),$("<div/>",{"class":"help"}).append(b).append(a)},j=function(){var a,b;return b=$("<div/>",{"class":"title"}).html("skills"),a=$("<div/>",{id:"skills","class":"content"}),$("<div/>",{"class":"skills"}).append(b).append(a)},h=function(){var a;return a=$("<div/>",{id:"output","class":"content"}),$("<div/>",{"class":"output"}).append(a)},h=function(){var a;return a=$("<div/>",{id:"output","class":"content"}),$("<div/>",{"class":"output"}).append(a)},i=function(){var a;return a=$("<div/>",{id:"points","class":"content"}),$("<div/>",{"class":"points"}).append(a)},f=function(){var a,b;return b=$("<div/>",{id:"menu_title","class":"title"}).html(""),a=$("<div/>",{id:"menu_content","class":"content"}),$("<div/>",{id:"menu","class":"menu"}).append(b).append(a)},g=function(){return $("<div/>",{id:"menu_overlay","class":"overlay"})},a=function(){return $("<div/>",{id:"game_over"})},b=function(){return $("<div/>",{id:"game_over_overlay","class":"overlay"})},d=function(){var d;return d=$("#game"),$(d).append(e()),$(d).append(k()),$(d).append(c()),$(d).append(j()),$(d).append(h()),$(d).append(i()),$(d).append(g()),$(d).append(f()),$(d).append(a()),$(d).append(b())},l.create_layout=d}.call(this),function(){var a,b;b=typeof exports!="undefined"&&exports!==null?exports:this,a=null,$(document).ready(function(){var b,c;return create_layout(),a=new Keyboard($("#game")),b=new Game,c=new GamePresenter(b),b.on_update(function(){return c.update()}),a.set_target(b),b.start()})}.call(this),function(){}.call(this)